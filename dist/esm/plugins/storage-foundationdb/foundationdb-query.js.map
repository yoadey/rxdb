{"version":3,"file":"foundationdb-query.js","names":["changeIndexableStringByOneQuantum","getStartIndexStringFromLowerBound","getStartIndexStringFromUpperBound","ensureNotFalsy","lastOfArray","getFoundationDBIndexName","getQueryMatcher","getSortComparator","queryFoundationDB","instance","preparedQuery","queryPlan","query","skip","limit","Infinity","skipPlusLimit","queryPlanFields","index","mustManuallyResort","sortSatisfiedByIndex","queryMatcher","selectorSatisfiedByIndex","schema","dbs","internals","dbsPromise","indexForName","slice","indexName","indexDB","indexes","db","lowerBound","startKeys","lowerBoundString","upperBound","endKeys","upperBoundString","result","root","doTransaction","tx","innerResult","indexTx","at","subspace","mainTx","main","docId","get","docData","push","inclusiveStart","inclusiveEnd","range","getRangeBatch","done","next","rows","value","firstRow","shift","lastRow","pop","docIds","map","row","docsData","Promise","all","forEach","length","return","sortComparator","sort","documents"],"sources":["../../../../src/plugins/storage-foundationdb/foundationdb-query.ts"],"sourcesContent":["import {\n    changeIndexableStringByOneQuantum,\n    getStartIndexStringFromLowerBound,\n    getStartIndexStringFromUpperBound\n} from '../../custom-index.ts';\nimport type {\n    PreparedQuery,\n    QueryMatcher,\n    RxDocumentData,\n    RxStorageQueryResult\n} from '../../types/index.d.ts';\nimport { ensureNotFalsy, lastOfArray } from '../../plugins/utils/index.ts';\nimport { getFoundationDBIndexName } from './foundationdb-helpers.ts';\nimport { RxStorageInstanceFoundationDB } from './rx-storage-instance-foundationdb.ts';\nimport { getQueryMatcher, getSortComparator } from '../../rx-query-helper.ts';\n\nexport async function queryFoundationDB<RxDocType>(\n    instance: RxStorageInstanceFoundationDB<RxDocType>,\n    preparedQuery: PreparedQuery<RxDocType>\n): Promise<RxStorageQueryResult<RxDocType>> {\n    const queryPlan = preparedQuery.queryPlan;\n    const query = preparedQuery.query;\n    const skip = query.skip ? query.skip : 0;\n    const limit = query.limit ? query.limit : Infinity;\n    const skipPlusLimit = skip + limit;\n    const queryPlanFields: string[] = queryPlan.index;\n    const mustManuallyResort = !queryPlan.sortSatisfiedByIndex;\n\n\n    let queryMatcher: QueryMatcher<RxDocumentData<RxDocType>> | false = false;\n    if (!queryPlan.selectorSatisfiedByIndex) {\n        queryMatcher = getQueryMatcher(\n            instance.schema,\n            preparedQuery.query\n        );\n    }\n\n    const dbs = await instance.internals.dbsPromise;\n\n\n    const indexForName = queryPlanFields.slice(0);\n    const indexName = getFoundationDBIndexName(indexForName);\n    const indexDB = ensureNotFalsy(dbs.indexes[indexName]).db;\n\n    let lowerBound: any[] = queryPlan.startKeys;\n    let lowerBoundString = getStartIndexStringFromLowerBound(\n        instance.schema,\n        indexForName,\n        lowerBound\n    );\n\n    let upperBound: any[] = queryPlan.endKeys;\n    let upperBoundString = getStartIndexStringFromUpperBound(\n        instance.schema,\n        indexForName,\n        upperBound\n    );\n    let result: RxDocumentData<RxDocType>[] = await dbs.root.doTransaction(async (tx: any) => {\n        const innerResult: RxDocumentData<RxDocType>[] = [];\n        const indexTx = tx.at(indexDB.subspace);\n        const mainTx = tx.at(dbs.main.subspace);\n\n\n        /**\n         * TODO for whatever reason the keySelectors like firstGreaterThan etc.\n         * do not work properly. So we have to hack here to find the correct\n         * document in case lowerBoundString===upperBoundString.\n         * This likely must be fixed in the foundationdb library.\n         * When it is fixed, we do not need this if-case and instead\n         * can rely on .getRangeBatch() in all cases.\n         */\n        if (lowerBoundString === upperBoundString) {\n            const docId: string = await indexTx.get(lowerBoundString);\n            if (docId) {\n                const docData = await mainTx.get(docId);\n                if (!queryMatcher || queryMatcher(docData)) {\n                    innerResult.push(docData);\n                }\n            }\n            return innerResult;\n        }\n\n        if (!queryPlan.inclusiveStart) {\n            lowerBoundString = changeIndexableStringByOneQuantum(lowerBoundString, 1);\n        }\n        if (queryPlan.inclusiveEnd) {\n            upperBoundString = changeIndexableStringByOneQuantum(upperBoundString, +1);\n        }\n\n        const range = indexTx.getRangeBatch(\n            lowerBoundString,\n            upperBoundString,\n            // queryPlan.inclusiveStart ? keySelector.firstGreaterThan(lowerBoundString) : keySelector.firstGreaterOrEqual(lowerBoundString),\n            // queryPlan.inclusiveEnd ? keySelector.lastLessOrEqual(upperBoundString) : keySelector.lastLessThan(upperBoundString),\n            {\n                // TODO these options seem to be broken in the foundationdb node bindings\n                // limit: instance.settings.batchSize,\n                // streamingMode: StreamingMode.Exact\n            }\n        );\n        let done = false;\n        while (!done) {\n            const next = await range.next();\n            if (next.done) {\n                done = true;\n                break;\n            }\n            const rows: [string, string] = next.value;\n\n            if (!queryPlan.inclusiveStart) {\n                const firstRow = rows[0];\n                if (\n                    firstRow &&\n                    firstRow[0] === lowerBoundString\n                ) {\n                    rows.shift();\n                }\n            }\n            if (!queryPlan.inclusiveEnd) {\n                const lastRow = lastOfArray(rows);\n                if (\n                    lastRow &&\n                    lastRow[0] === upperBoundString\n                ) {\n                    rows.pop();\n                }\n            }\n\n            const docIds = rows.map(row => row[1]);\n            const docsData: RxDocumentData<RxDocType>[] = await Promise.all(docIds.map((docId: string) => mainTx.get(docId)));\n\n            docsData.forEach((docData) => {\n                if (!done) {\n                    if (!queryMatcher || queryMatcher(docData)) {\n                        innerResult.push(docData);\n                    }\n                }\n                if (\n                    !mustManuallyResort &&\n                    innerResult.length === skipPlusLimit\n                ) {\n                    done = true;\n                    range.return();\n                }\n            });\n        }\n        return innerResult;\n    });\n    if (mustManuallyResort) {\n        const sortComparator = getSortComparator(instance.schema, preparedQuery.query);\n        result = result.sort(sortComparator);\n    }\n\n    // apply skip and limit boundaries.\n    result = result.slice(skip, skipPlusLimit);\n\n    return {\n        documents: result\n    };\n}\n"],"mappings":"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","ignoreList":[]}