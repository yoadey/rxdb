{"version":3,"file":"index.js","names":["ensureNotFalsy","errorToPlainJson","RxDBLeaderElectionPlugin","RxReplicationState","startReplicationOnLeaderShip","addRxPlugin","newRxError","Subject","connect","DeliverPolicy","JSONCodec","ReplayPolicy","getNatsServerDocumentState","awaitRetry","RxNatsReplicationState","_RxReplicationState","replicationIdentifier","collection","pull","push","live","retryTime","autoStart","_this","call","_inheritsLoose","replicateNats","options","waitForLeadership","primaryPath","schema","jc","connectionStatePromise","nc","connection","jetstreamClient","jetstream","jsm","jetstreamManager","streams","add","name","streamName","subjects","subjectPrefix","natsStream","get","pullStream$","replicationPrimitivesPull","handler","lastPulledCheckpoint","batchSize","cn","newCheckpoint","sequence","consumer","getConsumer","opt_start_seq","deliver_policy","LastPerSubject","replay_policy","Instant","fetchedMessages","fetch","max_messages","signal","close","useMessages","m","json","seq","ack","documents","checkpoint","modifier","stream$","asObservable","replicationPrimitivesPush","rows","conflicts","Promise","all","map","writeRow","docId","newDocumentState","remoteDocState","err","message","includes","assumedMasterState","conflictHandler","realMasterState","isEqual","pushDone","publish","encode","expect","lastSubjectSequence","undefined","newServerState","replicationState","error","next","document","startBefore","start","bind","cancelBefore","cancel","lastSeq","lastDocState","getMessage","last_by_subj","newMessages","consume","docData"],"sources":["../../../../src/plugins/replication-nats/index.ts"],"sourcesContent":["import {\n    ensureNotFalsy,\n    errorToPlainJson\n} from '../../plugins/utils/index.ts';\n\n\nimport { RxDBLeaderElectionPlugin } from '../leader-election/index.ts';\nimport type {\n    RxCollection,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxReplicationWriteToMasterRow,\n    RxReplicationPullStreamItem\n} from '../../types/index.d.ts';\nimport {\n    RxReplicationState,\n    startReplicationOnLeaderShip\n} from '../replication/index.ts';\nimport {\n    addRxPlugin,\n    newRxError,\n    WithDeleted\n} from '../../index.ts';\n\nimport { Subject } from 'rxjs';\nimport type {\n    NatsCheckpointType,\n    NatsSyncOptions\n} from './nats-types.ts';\nimport { connect, DeliverPolicy, JSONCodec, ReplayPolicy } from 'nats';\nimport { getNatsServerDocumentState } from './nats-helper.ts';\nimport { awaitRetry } from '../replication/replication-helper.ts';\n\nexport * from './nats-types.ts';\nexport * from './nats-helper.ts';\n\n\nexport class RxNatsReplicationState<RxDocType> extends RxReplicationState<RxDocType, NatsCheckpointType> {\n    constructor(\n        public readonly replicationIdentifier: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly pull?: ReplicationPullOptions<RxDocType, NatsCheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live: boolean = true,\n        public retryTime: number = 1000 * 5,\n        public autoStart: boolean = true\n    ) {\n        super(\n            replicationIdentifier,\n            collection,\n            '_deleted',\n            pull,\n            push,\n            live,\n            retryTime,\n            autoStart\n        );\n    }\n}\n\n\n\nexport function replicateNats<RxDocType>(\n    options: NatsSyncOptions<RxDocType>\n): RxNatsReplicationState<RxDocType> {\n    options.live = typeof options.live === 'undefined' ? true : options.live;\n    options.waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\n\n    const collection = options.collection;\n    const primaryPath = collection.schema.primaryPath;\n    addRxPlugin(RxDBLeaderElectionPlugin);\n\n    const jc = JSONCodec();\n\n\n    const connectionStatePromise = (async () => {\n        const nc = await connect(options.connection);\n        const jetstreamClient = nc.jetstream();\n        const jsm = await nc.jetstreamManager();\n        await jsm.streams.add({\n            name: options.streamName, subjects: [\n                options.subjectPrefix + '.*'\n            ]\n        });\n        const natsStream = await jetstreamClient.streams.get(options.streamName);\n        return {\n            nc,\n            jetstreamClient,\n            jsm,\n            natsStream\n        };\n    })();\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, NatsCheckpointType>> = new Subject();\n\n    let replicationPrimitivesPull: ReplicationPullOptions<RxDocType, NatsCheckpointType> | undefined;\n    if (options.pull) {\n        replicationPrimitivesPull = {\n            async handler(\n                lastPulledCheckpoint: NatsCheckpointType | undefined,\n                batchSize: number\n            ) {\n                const cn = await connectionStatePromise;\n                const newCheckpoint: NatsCheckpointType = {\n                    sequence: lastPulledCheckpoint ? lastPulledCheckpoint.sequence : 0\n                };\n                const consumer = await cn.natsStream.getConsumer({\n                    opt_start_seq: lastPulledCheckpoint ? lastPulledCheckpoint.sequence : 0,\n                    deliver_policy: DeliverPolicy.LastPerSubject,\n                    replay_policy: ReplayPolicy.Instant\n                });\n\n                const fetchedMessages = await consumer.fetch({\n                    max_messages: batchSize\n                });\n                await (fetchedMessages as any).signal;\n                await fetchedMessages.close();\n\n                const useMessages: WithDeleted<RxDocType>[] = [];\n                for await (const m of fetchedMessages) {\n                    useMessages.push(m.json());\n                    newCheckpoint.sequence = m.seq;\n                    m.ack();\n                }\n                return {\n                    documents: useMessages,\n                    checkpoint: newCheckpoint\n                };\n            },\n            batchSize: ensureNotFalsy(options.pull).batchSize,\n            modifier: ensureNotFalsy(options.pull).modifier,\n            stream$: pullStream$.asObservable()\n        };\n    }\n\n\n    let replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined;\n    if (options.push) {\n        replicationPrimitivesPush = {\n            async handler(\n                rows: RxReplicationWriteToMasterRow<RxDocType>[]\n            ) {\n                const cn = await connectionStatePromise;\n                const conflicts: WithDeleted<RxDocType>[] = [];\n                await Promise.all(\n                    rows.map(async (writeRow) => {\n                        const docId = (writeRow.newDocumentState as any)[primaryPath];\n\n                        /**\n                         * first get the current state of the documents from the server\n                         * so that we have the sequence number for conflict detection.\n                         */\n                        let remoteDocState;\n                        try {\n                            remoteDocState = await getNatsServerDocumentState(\n                                cn.natsStream,\n                                options.subjectPrefix,\n                                docId\n                            );\n                        } catch (err: Error | any) {\n                            if (!err.message.includes('no message found')) {\n                                throw err;\n                            }\n                        }\n\n                        if (\n                            remoteDocState &&\n                            (\n                                !writeRow.assumedMasterState ||\n                                (await collection.conflictHandler({\n                                    newDocumentState: remoteDocState.json(),\n                                    realMasterState: writeRow.assumedMasterState\n                                }, 'replication-firestore-push')).isEqual === false\n                            )\n                        ) {\n                            // conflict\n                            conflicts.push(remoteDocState.json());\n                        } else {\n                            // no conflict (yet)\n                            let pushDone = false;\n                            while (!pushDone) {\n                                try {\n                                    await cn.jetstreamClient.publish(\n                                        options.subjectPrefix + '.' + docId,\n                                        jc.encode(writeRow.newDocumentState),\n                                        {\n                                            expect: remoteDocState ? {\n                                                streamName: options.streamName,\n                                                lastSubjectSequence: remoteDocState.seq\n                                            } : undefined\n                                        }\n                                    );\n                                    pushDone = true;\n                                } catch (err: Error | any) {\n                                    if (err.message.includes('wrong last sequence')) {\n                                        // A write happened while we are doing our write -> handle conflict\n                                        const newServerState = await getNatsServerDocumentState(\n                                            cn.natsStream,\n                                            options.subjectPrefix,\n                                            docId\n                                        );\n                                        conflicts.push(ensureNotFalsy(newServerState).json());\n                                        pushDone = true;\n                                    } else {\n                                        replicationState.subjects.error.next(\n                                            newRxError('RC_STREAM', {\n                                                document: writeRow.newDocumentState,\n                                                error: errorToPlainJson(err)\n                                            })\n                                        );\n\n                                        // -> retry after wait\n                                        await awaitRetry(\n                                            collection,\n                                            replicationState.retryTime\n                                        );\n                                    }\n                                }\n                            }\n                        }\n                    })\n                );\n                return conflicts;\n            },\n            batchSize: options.push.batchSize,\n            modifier: options.push.modifier\n        };\n    }\n\n\n    const replicationState = new RxNatsReplicationState<RxDocType>(\n        options.replicationIdentifier,\n        collection,\n        replicationPrimitivesPull,\n        replicationPrimitivesPush,\n        options.live,\n        options.retryTime,\n        options.autoStart\n    );\n\n    /**\n     * Use long polling to get live changes for the pull.stream$\n     */\n    if (options.live && options.pull) {\n        const startBefore = replicationState.start.bind(replicationState);\n        const cancelBefore = replicationState.cancel.bind(replicationState);\n        replicationState.start = async () => {\n            const cn = await connectionStatePromise;\n\n            /**\n             * First get the last sequence so that we can\n             * laster only fetch 'newer' messages.\n             */\n            let lastSeq = 0;\n            try {\n                const lastDocState = await cn.natsStream.getMessage({\n                    last_by_subj: options.subjectPrefix + '.*'\n                });\n                lastSeq = lastDocState.seq;\n            } catch (err: any | Error) {\n                if (!err.message.includes('no message found')) {\n                    throw err;\n                }\n            }\n\n            const consumer = await cn.natsStream.getConsumer({\n                opt_start_seq: lastSeq\n            });\n            const newMessages = await consumer.consume();\n            (async () => {\n                for await (const m of newMessages) {\n                    const docData: WithDeleted<RxDocType> = m.json();\n                    pullStream$.next({\n                        documents: [docData],\n                        checkpoint: {\n                            sequence: m.seq\n                        }\n                    });\n                    m.ack();\n                }\n            })();\n            replicationState.cancel = () => {\n                newMessages.close();\n                return cancelBefore();\n            };\n            return startBefore();\n        };\n    }\n\n    startReplicationOnLeaderShip(options.waitForLeadership, replicationState);\n\n    return replicationState;\n}\n"],"mappings":"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","ignoreList":[]}