{"version":3,"file":"index.js","names":["Subject","PROMISE_RESOLVE_VOID","getFromMapOrThrow","createWebSocketClient","startSocketServer","exposeRxStorageRemote","getRxStorageRemote","createErrorAnswer","startRxStorageRemoteWebsocketServer","options","serverState","websocketByConnectionId","Map","messages$","exposeSettings","asObservable","storage","database","customRequestHandler","send","msg","ws","connectionId","JSON","stringify","exposeState","onConnection$","subscribe","onCloseHandlers","onclose","map","fn","on","messageString","message","parse","has","method","Error","set","next","getRxStorageRemoteWebsocket","identifier","url","join","mode","messageChannelCreator","websocketClient","message$","socket","close"],"sources":["../../../../src/plugins/storage-remote-websocket/index.ts"],"sourcesContent":["import { Subject } from 'rxjs';\nimport type {\n    WebSocket\n} from 'ws';\nimport {\n    PROMISE_RESOLVE_VOID,\n    getFromMapOrThrow\n} from '../../plugins/utils/index.ts';\nimport {\n    createWebSocketClient,\n    startSocketServer\n} from '../replication-websocket/index.ts';\nimport { exposeRxStorageRemote } from '../storage-remote/remote.ts';\nimport { getRxStorageRemote } from '../storage-remote/rx-storage-remote.ts';\nimport { createErrorAnswer } from '../storage-remote/storage-remote-helpers.ts';\nimport type {\n    MessageFromRemote,\n    MessageToRemote,\n    RxStorageRemoteExposeSettings\n} from '../storage-remote/storage-remote-types.ts';\nimport type {\n    RxStorageRemoteWebsocketClient,\n    RxStorageRemoteWebsocketClientOptions,\n    RxStorageRemoteWebsocketServerOptions,\n    RxStorageRemoteWebsocketServerState\n} from './types.ts';\nexport function startRxStorageRemoteWebsocketServer(\n    options: RxStorageRemoteWebsocketServerOptions\n): RxStorageRemoteWebsocketServerState {\n    const serverState = startSocketServer(options);\n\n    const websocketByConnectionId = new Map<string, WebSocket>();\n    const messages$ = new Subject<MessageToRemote>();\n    const exposeSettings: RxStorageRemoteExposeSettings = {\n        messages$: messages$.asObservable(),\n        storage: options.storage as any,\n        database: options.database as any,\n        customRequestHandler: options.customRequestHandler,\n        send(msg) {\n            const ws = getFromMapOrThrow(websocketByConnectionId, msg.connectionId);\n            ws.send(JSON.stringify(msg));\n        }\n    };\n    const exposeState = exposeRxStorageRemote(exposeSettings);\n\n    serverState.onConnection$.subscribe(ws => {\n        const onCloseHandlers: Function[] = [];\n        ws.onclose = () => {\n            onCloseHandlers.map(fn => fn());\n        };\n        ws.on('message', (messageString: string) => {\n            const message: MessageToRemote = JSON.parse(messageString);\n            const connectionId = message.connectionId;\n            if (!websocketByConnectionId.has(connectionId)) {\n                /**\n                 * If first message is not 'create',\n                 * it is an error.\n                 */\n                if (\n                    message.method !== 'create' &&\n                    message.method !== 'custom'\n                ) {\n                    ws.send(\n                        JSON.stringify(\n                            createErrorAnswer(message, new Error('First call must be a create call but is: ' + JSON.stringify(message)))\n                        )\n                    );\n                    return;\n                }\n                websocketByConnectionId.set(connectionId, ws);\n            }\n            messages$.next(message);\n        });\n    });\n\n    return {\n        serverState,\n        exposeState\n    };\n}\n\nexport function getRxStorageRemoteWebsocket(\n    options: RxStorageRemoteWebsocketClientOptions\n): RxStorageRemoteWebsocketClient {\n    const identifier = [\n        options.url,\n        'rx-remote-storage-websocket'\n    ].join('');\n    const storage = getRxStorageRemote({\n        identifier,\n        mode: options.mode,\n        async messageChannelCreator() {\n            const messages$ = new Subject<MessageFromRemote>();\n            const websocketClient = await createWebSocketClient(options as any);\n            websocketClient.message$.subscribe(msg => messages$.next(msg));\n            return {\n                messages$,\n                send(msg) {\n                    return websocketClient.socket.send(JSON.stringify(msg));\n                },\n                close() {\n                    websocketClient.socket.close();\n                    return PROMISE_RESOLVE_VOID;\n                }\n            };\n\n        }\n    });\n    return storage;\n}\n\n\nexport * from './types.ts';\n\n"],"mappings":"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","ignoreList":[]}